# EPS æ’ç¨‹å¼•æ“æ•´åˆæŒ‡å—

## ğŸ¯ å®Œæˆç‹€æ…‹

âœ… **Phase 1-5**: æ’ç¨‹å¼•æ“æ ¸å¿ƒå®Œæˆ  
âœ… **å¾Œç«¯API**: æ’ç¨‹ç«¯é»å·²å‰µå»º  
âœ… **å‰ç«¯æ•´åˆ**: æ’ç¨‹é é¢å·²ä¿®æ”¹  
â³ **æ¸¬è©¦**: å¾…å¾Œç«¯å•Ÿå‹•å¾Œæ¸¬è©¦

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### å¾Œç«¯ (Backend)

1. **schemas_scheduling.py** (NEW)
   - `SchedulingRequest`: æ’ç¨‹è«‹æ±‚æ¨¡å‹
   - `ScheduleBlockResponse`: æ’ç¨‹å€å¡ŠéŸ¿æ‡‰
   - `SchedulingResponse`: å®Œæ•´æ’ç¨‹éŸ¿æ‡‰

2. **main.py** (MODIFIED)
   - æ–°å¢æ’ç¨‹APIç«¯é»:
     * `POST /api/scheduling/run`: åŸ·è¡Œæ’ç¨‹
     * `GET /api/scheduling/status`: ç²å–æ’ç¨‹ç‹€æ…‹
   - å°å…¥æ’ç¨‹å¼•æ“æ¨¡çµ„

3. **test_scheduling_api.py** (NEW)
   - APIç«¯é»æ¸¬è©¦è…³æœ¬

### å‰ç«¯ (Frontend)

1. **api/api.ts** (MODIFIED)
   - æ–°å¢ `runScheduling()`: èª¿ç”¨æ’ç¨‹API
   - æ–°å¢ `getSchedulingStatus()`: ç²å–ç‹€æ…‹

2. **pages/Scheduling.tsx** (MODIFIED)
   - ç§»é™¤èˆŠçš„ AI æ’ç¨‹é‚è¼¯
   - æ–°å¢ `handleScheduling()`: èª¿ç”¨å¾Œç«¯æ’ç¨‹å¼•æ“
   - ä¿®æ”¹é…ç½®å°è©±æ¡†: ç°¡åŒ–ç‚ºåˆä½µé–‹é—œã€çª—å£ã€é–¾å€¼
   - ä¿®æ”¹æŒ‰éˆ•æ–‡å­—: "AIè‡ªå‹•æ’ç¨‹" â†’ "é–‹å§‹æ’ç¨‹"
   - æ–°å¢æ’ç¨‹ç‹€æ…‹: `isScheduling`
   - çµæœè½‰æ›: å°‡ ScheduleBlock è½‰ç‚º WorkOrder

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. å•Ÿå‹•å¾Œç«¯æœå‹™å™¨

```bash
cd backend
python main.py
```

### 2. å•Ÿå‹•å‰ç«¯

```bash
cd frontend
npm run dev
```

### 3. åœ¨æ’ç¨‹é é¢åŸ·è¡Œæ’ç¨‹

1. é»æ“Š "ğŸš€ é–‹å§‹æ’ç¨‹" æŒ‰éˆ•
2. é…ç½®æ’ç¨‹åƒæ•¸:
   - â˜‘ è¨‚å–®åˆä½µ: å•Ÿç”¨/é—œé–‰
   - åˆä½µçª—å£: 1-5é€± (é è¨­2é€±)
   - æˆå‹æ™‚é–“é–¾å€¼: 5-20% (é è¨­10%)
3. é»æ“Š "ğŸš€ é–‹å§‹æ’ç¨‹"
4. ç­‰å¾…æ’ç¨‹å®Œæˆï¼ˆé¡¯ç¤ºçµ±è¨ˆè³‡è¨Šï¼‰
5. æ’ç¨‹çµæœè‡ªå‹•é¡¯ç¤ºåœ¨ç”˜ç‰¹åœ–ä¸­

## ğŸ“Š æ’ç¨‹æµç¨‹

```
ç”¨æˆ¶é»æ“Š"é–‹å§‹æ’ç¨‹"
    â†“
å‰ç«¯èª¿ç”¨ api.runScheduling()
    â†“
POST /api/scheduling/run
    â†“
å¾Œç«¯: ç²å–å¾…æ’ç¨‹è¨‚å–®ï¼ˆç‹€æ…‹â‰ å·²å®Œæˆï¼‰
    â†“
å¾Œç«¯: è½‰æ›ç‚º ManufacturingOrder
    â†“
å¾Œç«¯: èª¿ç”¨ SchedulingEngine.schedule()
    â†“
æ’ç¨‹å¼•æ“: åŸ·è¡Œ5éšæ®µæ’ç¨‹
    â†“
å¾Œç«¯: ä¿å­˜åˆ° ComponentSchedule è¡¨
    â†“
å¾Œç«¯: è¿”å› SchedulingResponse
    â†“
å‰ç«¯: è½‰æ›ç‚º WorkOrder ä¸¦é¡¯ç¤ºåœ¨ç”˜ç‰¹åœ–
    â†“
å®Œæˆï¼
```

## ğŸ”§ APIè©³ç´°èªªæ˜

### POST /api/scheduling/run

**è«‹æ±‚é«”**:
```json
{
  "order_ids": ["MO-001", "MO-002"],  // å¯é¸ï¼Œç©ºå‰‡æ’æ‰€æœ‰
  "merge_enabled": true,
  "merge_window_weeks": 2,
  "time_threshold_pct": 10
}
```

**éŸ¿æ‡‰**:
```json
{
  "success": true,
  "message": "æ’ç¨‹æˆåŠŸ: 10 å€‹åˆ¶ä»¤å·²æ’ç¨‹",
  "blocks": [
    {
      "block_id": "BLOCK-001",
      "machine_id": "A09",
      "mold_code": "6J201004A",
      "start_time": "2025-12-22T08:00:00",
      "end_time": "2025-12-22T18:36:00",
      "mo_ids": ["MO-001"],
      "component_codes": ["1J20342PFC0200D0"],
      "product_display": "1J20342PFC0200D0",
      "status": "SCHEDULED",
      "is_merged": false
    }
  ],
  "scheduled_mos": ["MO-001", "MO-002"],
  "failed_mos": [],
  "total_mos": 10,
  "on_time_count": 8,
  "late_count": 2,
  "total_lateness_days": 0.5,
  "changeover_count": 10,
  "delay_reports": [],
  "change_log": [],
  "execution_time_seconds": 1.23
}
```

### GET /api/scheduling/status

**éŸ¿æ‡‰**:
```json
{
  "pending_orders": 25,
  "scheduled_orders": 15,
  "last_schedule_time": null
}
```

## ğŸ¨ å‰ç«¯æ”¹å‹•èªªæ˜

### é…ç½®å°è©±æ¡†è®ŠåŒ–

**ä¹‹å‰**:
- æ’ç¨‹ç­–ç•¥: å“è³ªå„ªå…ˆ / æ™‚é–“å„ªå…ˆ / é »ç‡å„ªå…ˆ
- åˆä½µç­–ç•¥: åˆä½µæ‰€æœ‰ / äº¤æœŸå…§åˆä½µ

**ç¾åœ¨**:
- â˜‘ è¨‚å–®åˆä½µ: é–‹é—œ
- åˆä½µçª—å£: æ•¸å­—è¼¸å…¥ (1-5é€±)
- æˆå‹æ™‚é–“é–¾å€¼: æ•¸å­—è¼¸å…¥ (5-20%)

### æŒ‰éˆ•è®ŠåŒ–

**ä¹‹å‰**: "AI é‡æ–°æ’ç¨‹"  
**ç¾åœ¨**: "ğŸš€ é–‹å§‹æ’ç¨‹" / "â³ æ’ç¨‹ä¸­..."

### æ’ç¨‹é‚è¼¯è®ŠåŒ–

**ä¹‹å‰**: å‰ç«¯åŸ·è¡Œ `executeAutoScheduling()` (æœ¬åœ°æ¼”ç®—æ³•)  
**ç¾åœ¨**: èª¿ç”¨å¾Œç«¯API `api.runScheduling()` (æ’ç¨‹å¼•æ“)

## ğŸ“ æ³¨æ„äº‹é …

1. **åªæ’åŠæˆå“**: æ’ç¨‹å¼•æ“åªè™•ç†1å­—é ­å“è™Ÿ
2. **è¨‚å–®ç‹€æ…‹**: åªæ’ç¨‹ç‹€æ…‹â‰ "å·²å®Œæˆ"çš„è¨‚å–®
3. **æ™‚é–“è½‰æ›**: å¾Œç«¯è¿”å› ISO æ™‚é–“ï¼Œå‰ç«¯è½‰ç‚ºå°æ™‚åç§»
4. **å€å¡ŠID**: ä½¿ç”¨å¾Œç«¯ç”Ÿæˆçš„ block_id
5. **åˆä½µæ¨™è¨˜**: is_merged æ¨™è¨˜åˆä½µè¨‚å–®
6. **AIé–å®š**: æ’ç¨‹çµæœè¨­ç½® aiLocked=true

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. æ¸¬è©¦APIç«¯é»

```bash
cd backend
python test_scheduling_api.py
```

### 2. æ¸¬è©¦å®Œæ•´æµç¨‹

1. ç¢ºä¿æœ‰å¾…æ’ç¨‹è¨‚å–® (Orders è¡¨)
2. ç¢ºä¿æœ‰æ¨¡å…·è³‡æ–™ (Molds è¡¨, 1å­—é ­å“è™Ÿ)
3. ç¢ºä¿æœ‰å·¥ä½œæ—¥æ›† (WorkCalendarDay è¡¨)
4. å‰ç«¯: é€²å…¥æ’ç¨‹é é¢
5. é»æ“Š"é–‹å§‹æ’ç¨‹"
6. æª¢æŸ¥æ’ç¨‹çµæœ
7. æª¢æŸ¥ ComponentSchedule è¡¨æ˜¯å¦æœ‰æ•¸æ“š

### 3. é©—è­‰çµæœ

- [ ] æ’ç¨‹çµæœé¡¯ç¤ºåœ¨ç”˜ç‰¹åœ–ä¸­
- [ ] å€å¡Šç„¡æ™‚é–“é‡ç–Š
- [ ] æ¨¡å…·ç„¡ä¸¦è¡Œè¡çª
- [ ] åˆä½µè¨‚å–®æ­£ç¢ºæ¨™è¨˜
- [ ] å»¶é²è¨‚å–®æ­£ç¢ºè¨ˆç®—

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: "æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„åŠæˆå“è¨‚å–®"
**A**: æª¢æŸ¥è¨‚å–®çš„ product_code æ˜¯å¦ç‚º1å­—é ­ï¼Œæ˜¯å¦æœ‰å°æ‡‰æ¨¡å…·è³‡æ–™

### Q2: "æ’ç¨‹å¤±æ•—: unhashable type"
**A**: å·²ä¿®æ­£ï¼Œç¢ºä¿ä½¿ç”¨æœ€æ–°çš„ scheduling_engine.py

### Q3: æ™‚é–“é¡¯ç¤ºä¸æ­£ç¢º
**A**: æª¢æŸ¥ selectedDate æ˜¯å¦æ­£ç¢ºè¨­ç½®ï¼Œæ™‚é–“è½‰æ›é‚è¼¯æ˜¯å¦æ­£ç¢º

### Q4: ç”˜ç‰¹åœ–ç„¡é¡¯ç¤º
**A**: æª¢æŸ¥ workOrders ç‹€æ…‹æ˜¯å¦æ›´æ–°ï¼ŒstartHour/endHour æ˜¯å¦è¨ˆç®—æ­£ç¢º

## ğŸ“ˆ ä¸‹ä¸€æ­¥å„ªåŒ–

1. **å³æ™‚æ›´æ–°**: WebSocket æ¨é€æ’ç¨‹é€²åº¦
2. **æ­·å²è¨˜éŒ„**: ä¿å­˜æ’ç¨‹æ­·å²ä¾›æ¯”å°
3. **è¡çªæª¢æ¸¬**: å‰ç«¯å³æ™‚æª¢æ¸¬æ’ç¨‹è¡çª
4. **æ‹–æ”¾æ•´åˆ**: æ‰‹å‹•èª¿æ•´å¾Œé‡æ–°è¨ˆç®—
5. **æ‰¹æ¬¡æ’ç¨‹**: æ”¯æ´åˆ†æ‰¹æ’ç¨‹å¤§é‡è¨‚å–®

## ğŸ“„ ç›¸é—œæ–‡æª”

- [æ’ç¨‹å¼•æ“README](backend/scheduling/README.md)
- [æ¸¬è©¦å ±å‘Š](backend/test_scheduling_engine.py)
- [APIæ–‡æª”](backend/main.py)

---

**æ•´åˆå®Œæˆæ™‚é–“**: 2025-12-21  
**ç‰ˆæœ¬**: 1.0.0  
**ç‹€æ…‹**: âœ… æ•´åˆå®Œæˆï¼Œå¾…æ¸¬è©¦

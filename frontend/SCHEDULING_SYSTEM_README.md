# 專業級排程系統 - 技術文件

## 概述

排程頁面已從基礎的 UI 介面進化為**專業級排程工具**，採用統一的時間座標系統、可縮放時間軸、以及精確的拖放功能。

---

## 核心特點

### 1. 統一時間座標系 (Unified Timeline Coordinate System)

所有元素（卡片、刻度、背景線）都基於同一套時間座標公式：

```typescript
x = (time - t0) / 1hr × baseHourWidth × zoom
width = durationHours × baseHourWidth × zoom
```

- **t0 = 08:00**：當日可排程起始時間
- **t1 = 20:00**：當日可排程結束時間
- **baseHourWidth = 80px**：zoom=1 時，1小時的基準寬度
- **zoom**：可調整倍率 (0.5x - 10x)

### 2. 動態時間刻度 (Dynamic Time Scale)

時間刻度會根據 zoom 級別自動調整顯示密度：

| Zoom Range | 刻度間隔 | 文字顯示 | 用途 |
|-----------|---------|---------|------|
| ≤ 1.5x | 1 小時 | 08:00, 09:00... | 全局概覽 |
| 1.5x - 3x | 30 分鐘 | 08:00, 08:30... | 中度細節 |
| 3x - 6x | 10 分鐘 | 每 10 分鐘 | 詳細規劃 |
| > 6x | 1 分鐘 | 每 10 分標註 | 精確調度 |

### 3. 水平捲動與縮放

- **Shift + 滾輪**：水平捲動時間軸
- **Ctrl/Cmd + 滾輪**：縮放時間軸
- **拖動縮放滑桿**：精確控制縮放級別
- **重置按鈕**：一鍵回到 1x 視角

### 4. 智能卡片顯示模式

系統根據 zoom 自動切換卡片顯示模式：

#### 詳細模式 (zoom < 2)
- 顯示：訂單 ID、產品、時間範圍、狀態 badge、鎖定圖示
- 卡片較大，適合一眼掃描

#### 精簡模式 (zoom ≥ 2)
- 顯示：訂單 ID + 精細時間
- 卡片變薄，節省空間
- Hover 可查看更多資訊

### 5. 拖曳輔助功能

拖動工單卡片時：

- **垂直對齊線**：跨機台的亮藍色對齊線
- **即時 Tooltip**：
  - 開始時間 (HH:MM)
  - 結束時間 (HH:MM)
  - 工時 (Xh Ym)
- **停機時段阻擋**：自動檢測衝突，禁止放置

### 6. Minimap 縮略圖

底部顯示整條時間軸的縮略視圖：

- 顯示所有工單的相對位置和狀態
- 藍色框框標示當前可見範圍
- 點擊任意位置快速跳轉

---

## 技術架構

### 核心 Hook: `useTimeline`

位置：`src/hooks/useTimeline.ts`

```typescript
const timeline = useTimeline()

// 可用屬性和方法
timeline.zoom              // 當前縮放級別
timeline.setZoom(newZoom)  // 設置縮放
timeline.timeToX(hour)     // 時間 → X 座標
timeline.durationToWidth(hours) // 工時 → 寬度
timeline.xToTime(x)        // X 座標 → 時間
timeline.t0                // 起始時間 (8)
timeline.t1                // 結束時間 (20)
timeline.totalWidth        // 時間軸總寬度
timeline.getTimeMarks()    // 取得時間刻度陣列
```

### 座標系常數

```typescript
const MACHINE_ROW_HEIGHT = 120  // 每個機台行高度
const MACHINE_LABEL_WIDTH = 120 // 機台標籤欄寬度
```

### 卡片定位方式

從 CSS Grid 改為**絕對定位**：

```tsx
<div style={{
  position: 'absolute',
  left: timeline.timeToX(order.startHour),
  width: timeline.durationToWidth(order.endHour - order.startHour),
  top: 8,
  height: MACHINE_ROW_HEIGHT - 16
}}>
  {/* 卡片內容 */}
</div>
```

### 拖拽實作

使用原生 `onMouseDown` + `useEffect` 監聽：

1. **Mouse Down**：記錄初始位置和偏移量
2. **Mouse Move**：計算新時間、更新對齊線、顯示 tooltip
3. **Mouse Up**：
   - 計算目標機台和時間
   - 檢查停機衝突
   - 更新工單狀態

---

## 使用指南

### 基本操作

1. **查看排程**
   - 使用滑桿調整 zoom (0.5x - 10x)
   - Shift + 滾輪左右捲動
   - 點擊 minimap 快速跳轉

2. **拖動工單**
   - 直接拖動卡片到新位置
   - 觀察藍色對齊線和時間 tooltip
   - 放開滑鼠完成移動

3. **切換視角**
   - 機台視角：按機台分組顯示（目前實作）
   - 訂單視角：按訂單分組顯示（待實作）

### 快捷鍵

| 操作 | 快捷鍵 |
|-----|-------|
| 水平捲動 | Shift + 滾輪 |
| 縮放 | Ctrl/Cmd + 滾輪 |
| 重置縮放 | 點擊「重置」按鈕 |

### 視覺提示

- **綠色左邊框**：生產中
- **黃色左邊框**：待機
- **紅色停機區塊**：不可排程
- **藍色對齊線**：拖動中的對齊參考
- **紅色虛線框**：拖動衝突警告

---

## 擴展功能建議

### 短期優化

1. **時間刻度貼齊 (Snap to Grid)**
   - 拖動時自動貼齊最近的時間刻度
   - 依 zoom 決定貼齊間隔（1hr / 30min / 10min / 5min）

2. **鍵盤快捷鍵**
   - 方向鍵微調工單位置
   - Delete 刪除選中工單
   - Ctrl+Z 撤銷操作

3. **多選與批次操作**
   - Shift+點擊多選工單
   - 批次移動到新時間/機台
   - 批次修改狀態

### 中期功能

1. **時間軸標記 (Timeline Markers)**
   - 當前時間線（即時更新）
   - 自訂標記（交班時間、檢查點）
   - 里程碑事件

2. **智能排程建議**
   - AI 分析閒置時段
   - 自動填補空檔
   - 最佳化機台利用率

3. **拖動預覽**
   - 顯示移動後的影響範圍
   - 預覽衝突和警告
   - 建議替代時間

### 長期規劃

1. **訂單視角**
   - 按訂單分組顯示
   - 多機台關聯顯示
   - 工序依賴關係

2. **甘特圖增強**
   - 關鍵路徑分析
   - 資源負載圖
   - 依賴關係箭頭

3. **協作功能**
   - 多人即時編輯
   - 變更歷史追蹤
   - 評論與標註

---

## 已知限制

1. **效能考量**
   - 超過 100 張工單卡片可能影響拖動流暢度
   - 建議使用虛擬滾動優化大數據集

2. **瀏覽器相容性**
   - 需要現代瀏覽器 (Chrome 90+, Firefox 88+, Safari 14+)
   - 觸控裝置拖動尚未優化

3. **資料持久化**
   - 目前僅前端狀態管理
   - 需整合後端 API 保存變更

---

## 維護與除錯

### 座標系檢查

如果卡片位置不準確，檢查：

1. `timeToX()` 計算是否正確
2. `MACHINE_LABEL_WIDTH` 是否與實際一致
3. `zoom` 狀態是否正確傳遞

### 拖動問題

如果拖動不順暢：

1. 檢查 `useEffect` 依賴項
2. 確認 `pointer-events` 沒有衝突
3. 驗證 `cursor` 樣式正確

### 效能優化

如果卡頓：

1. 減少時間刻度數量（調整 `getTimeMarks` 邏輯）
2. 使用 `React.memo` 優化卡片渲染
3. 考慮虛擬化長列表

---

## 變更日誌

### v2.0.0 - 專業級排程系統

- ✅ 統一時間座標系
- ✅ 動態縮放時間軸 (0.5x - 10x)
- ✅ 絕對定位替代 CSS Grid
- ✅ 智能卡片顯示模式切換
- ✅ 拖動對齊線與即時 tooltip
- ✅ Minimap 縮略圖導航
- ✅ 水平捲動與縮放快捷鍵
- ✅ 保留原有深色主題與視覺風格

### v1.0.0 - 基礎排程介面

- CSS Grid 固定刻度
- 基礎拖放功能
- 停機時段顯示
- 狀態篩選與圖例

---

## 聯絡與支援

如有任何問題或建議，請聯繫開發團隊。
